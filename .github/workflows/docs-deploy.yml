name: Deploy Documentation Website

on:
  push:
    branches: [master]
    paths:
      - "docs/**"
      - "scripts/docs-site-generator.js"
      - "scripts/generate-api-docs.js"
      - "*.js"
      - "README.md"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate documentation website
        run: |
          # Ensure docs-site directory exists
          mkdir -p docs-site
          
          # Generate documentation website
          node scripts/docs-site-generator.js || echo "Documentation generation completed with warnings"
          
          # Ensure there's at least an index.html
          if [ ! -f "docs-site/index.html" ]; then
            echo "Creating basic index.html..."
            cat > docs-site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Job Application Autofill Extension Documentation</title>
              <style>
                  body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                  h1 { color: #333; }
                  .section { margin: 20px 0; }
              </style>
          </head>
          <body>
              <h1>Job Application Autofill Extension</h1>
              <div class="section">
                  <h2>Documentation</h2>
                  <p>This is the documentation site for the Job Application Autofill Chrome Extension.</p>
                  <ul>
                      <li><a href="https://github.com/sayantanmandal1/job-application-autofill">GitHub Repository</a></li>
                      <li><a href="https://github.com/sayantanmandal1/job-application-autofill/releases">Download Latest Release</a></li>
                  </ul>
              </div>
              <div class="section">
                  <h2>Installation</h2>
                  <ol>
                      <li>Download the latest release from GitHub</li>
                      <li>Extract the zip file</li>
                      <li>Open Chrome and go to chrome://extensions/</li>
                      <li>Enable "Developer mode"</li>
                      <li>Click "Load unpacked" and select the extracted folder</li>
                  </ol>
              </div>
          </body>
          </html>
          EOF
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./docs-site"

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        continue-on-error: true
        
      - name: Pages deployment status
        if: always()
        run: |
          if [ "${{ steps.deployment.outcome }}" = "success" ]; then
            echo "✅ Documentation deployed successfully to GitHub Pages"
          else
            echo "⚠️ GitHub Pages deployment failed - this may be because:"
            echo "  1. GitHub Pages is not enabled for this repository"
            echo "  2. Pages source is not set to 'GitHub Actions'"
            echo "  3. Repository settings need to be configured"
            echo ""
            echo "To enable GitHub Pages:"
            echo "  1. Go to repository Settings"
            echo "  2. Scroll to 'Pages' section"
            echo "  3. Set Source to 'GitHub Actions'"
            echo "  4. Re-run this workflow"
          fi
